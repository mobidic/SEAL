{% extends 'base.html' %}

{% block static %}
    <link href="{{ url_for('static', filename='select2/css/select2.min.css') }}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='sweetalert/sweetalert2.min.css') }}" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='jquery-ui/jquery-ui.css') }}">
    {% include 'includes/loading_bar.dt.j2' %}

    <link href="{{ url_for('static', filename='seal/analysis/sample.css') }}" rel="stylesheet" type="text/css">
{% endblock %}

{% block content %}
    {% include 'includes/sidebar-sample.j2' %}
    <div class="w3-main {% if sample.status == 5 %}w3-disabled{% endif %}">
        <div class="w3-container">
            <div class="w3-center">
                <h1>{{ sample.samplename}}</h1>
                {% include 'includes/button-status-sample.j2' %}
            </div>
            <hr>
        </div>
        <div class="w3-padding w3-small">
            <div class="seal-form-report w3-row w3-padding {% if sample.status == 4 %}w3-disabled {% endif %}">
                <div class="w3-col l4 m6 s12 w3-row w3-padding">
                    <div class="w3-col w3-text-flat-green-sea l6 m6 s6"><p><i class="fa fa-filter fa-xl"></i> <b>Choose a filter</b></p></div>
                    <select id="selectFilter" class="w3-select w3-col l6 m6 s6 w3-border" onchange="changeFilter(value, '{{ sample.id }}');">
                    </select>
                </div>
                <div class="w3-col l4 m6 s12 w3-row w3-padding">
                    <div class="w3-col w3-text-flat-green-sea l6 m6 s6"><p><i class="fas fa-th-list fa-xl"></i> <b>Choose a panel</b></p></div>
                    <select id="selectBed" class="w3-select w3-col l6 m6 s6 w3-border" onchange="applied_panel(value, '{{ sample.id }}');">
                    </select>
                </div>
                <div class="w3-col l4 m6 s12 w3-row w3-padding">
                    <p class="w3-text-flat-green-sea"><i class="fa fa-circle-info fa-xl"></i> <b>Clinvar Version : <i>{{ clinvar.version }}</i></b></p>
                </div>
            </div>
            <div class="w3-padding">
                <table id="variants" class="w3-table display" style="width:100%">
                    <thead>
                        <tr>
                            <th rowspan="2" class='min-size-75'><span class="seal-display-middle-left w3-small">Gene</span></th>
                            <th rowspan="2" class='min-size-200 w3-border-right'><span class="seal-display-middle-left w3-small">HGVS</span></th>
                            <th rowspan="2" class="min-size-75 w3-border-right"><span class="seal-display-middle-left w3-small" style="left:10px;">Exon/intron</span></th>
                            <th colspan="{{ sample.caller|length }}" class="w3-border-right">Variant</th>
                            {% if family_members|length > 0 %}
                                <th colspan="{{ family_members|length }}" class="w3-border-right">Family<br /><span class="w3-text-flat-pumpkin w3-tiny"><i class="fa-solid fa-triangle-exclamation"></i> Only max values</span></th>
                            {% endif %}
                            <th rowspan="2" class="w3-border-right min-size-100"><span class="seal-display-middle-left w3-small">Population Frequency</span></th>
                            <th rowspan="2" class="w3-border-right min-size-150"><span class="seal-display-middle-left">Clinical Informations<br /><span class="w3-tiny">Clinvar/OMIM</span></span></th>
                            <th rowspan="2" class="w3-border-right w3-small"><span class="seal-display-middle-left">Consequences</span></th>
                            <th colspan="2" class="w3-border-right">Predictions</th>
                            <!-- <th  rowspan="2" class='min-size-2x5'><span class="seal-display-middle">R</span></th> -->
                            <th  rowspan="2" class='min-size-75'><span class="seal-display-middle">Class</span></th>
                            <th  rowspan="2" class=''></th>
                        </tr>
                        <tr>
                            <!-- <th class='min-size-75'>HGVSg</th> -->
                            <!-- <th class='min-size-200'>HGVS</th> -->
                            <!-- <th class='min-size-75'>HGVSp</th> -->
                            <!-- <th class='min-size-50'>E|I</th> -->
                            <!-- <th class='min-size-75'>Filter</th> -->
                            {% for c in sample.caller %}
                                <th class='min-size-75'>{{ c }}</th>
                            {% endfor %}
                            {% for s in family_members %}
                                <th class='min-size-75'>{{ s }}</th>
                            {% endfor %}
                            <!-- <th class='min-size-100'>GnomAD</th> -->
                            <!-- <th class='min-size-75'>SEAL</th> -->
                            <!-- <th class='min-size-100'>ClinVar</th>
                            <th class='min-size-75'>Transmission</th> -->
                            <!-- <th class='min-size-150'>Impact</th>
                            <th class='min-size-75'>Consequence</th> -->
                            <!-- <th class='min-size-50'>MaxEnt</th> -->
                            <th class='min-size-50'>MaxEnt/SpliceAI</th>
                            <th class='min-size-50'>Missense</th>
                        </tr>
                    </thead>
                    <tfoot>
                        <tr>
                            <th>
                                <span title="Help" onclick="openHelp(title='Gene', content='The gene symbol (e.g. HGNC) (where available) to the output.', footer='For more information see : <a  href=\'https://www.genenames.org/\' target=\'_blank\' style=\'text-decoration:underline\'><i>HGNC</i></a>')" class="w3-opacity-max w3-hover-opacity" style="cursor:pointer">
                                    <i class="fas fa-question-circle w3-tiny"></i>
                                </span>
                                Gene
                            </th>
                            <!-- <th></th> -->
                            <!-- <th>
                                <span title="Help" onclick="openHelp(title='HGVSg', content='The HGVS genomic sequence name', footer='For more information see : <a  href=\'https://varnomen.hgvs.org/\' target=\'_blank\' style=\'text-decoration:underline\'><i>varnomen</i></a>')" class="w3-opacity-max w3-hover-opacity" style="cursor:pointer">
                                    <i class="fas fa-question-circle w3-tiny"></i>
                                </span>
                                HGVSg
                            </th> -->
                            <th class="">
                                <span title="Help" onclick="openHelp(title='HGVS', content='The HGVS coding sequence name.<br /><br />Canonical transcript is defined by Ensembl algorithm following :<br /><ol><li>Longest CCDS translation with no stop codons.</li><li>If no (1), choose the longest Ensembl/Havana merged translation with no stop codons.</li><li>If no (2), choose the longest translation with no stop codons.</li><li>If no translation, choose the longest non-protein-coding transcript.</li></ol><br /><ul><li>the transcript is the canonical transcript for the gene<ul><li><i class=\'fas fa-star\'></i> (<i>canonical</i>)</li><li><i class=\'far fa-star\'></i> (<i>non canonical</i>)</li></ul></li><li>the transcript is one of your selected transcripts<ul><li><i class=\'w3-text-flat-peter-river fas fa-tint\'></i> (<i>selected</i>)</li><li><i class=\'fas fa-tint\'></i> (<i>not selected</i>)</li></ul></li></ul>', footer='For more information see : <a  href=\'https://varnomen.hgvs.org/\' target=\'_blank\' style=\'text-decoration:underline\'><i>varnomen</i></a>, <a  href=\'http://www.ensembl.org/info/genome/genebuild/canonical.html\' target=\'_blank\' style=\'text-decoration:underline\'><i>VEP documentation</i></a> & <a  href=\'{{ url_for('transcripts') }}\' target=\'_blank\' style=\'text-decoration:underline\'><i>Transcripts in SEAL</i></a>')" class="w3-opacity-max w3-hover-opacity" style="cursor:pointer">
                                    <i class="fas fa-question-circle w3-tiny"></i>
                                </span>
                                HGVSc
                            </th>
                            <!-- <th>
                                <span title="Help" onclick="openHelp(title='HGVSp', content='The HGVS protein sequence name', footer='For more information see : <a  href=\'https://varnomen.hgvs.org/\' target=\'_blank\' style=\'text-decoration:underline\'><i>varnomen</i></a>')" class="w3-opacity-max w3-hover-opacity" style="cursor:pointer">
                                    <i class="fas fa-question-circle w3-tiny"></i>
                                </span>
                                HGVSp
                            </th> -->
                            <th>
                                <span title="Help" onclick="openHelp(title='Exon/Intron', content='The number of the exon or intron wich have the variant.<br/><b>Exons are in bold</b>, <i>introns in italics.</i>', footer='')" class="w3-opacity-max w3-hover-opacity" style="cursor:pointer">
                                    <i class="fas fa-question-circle w3-tiny"></i>
                                </span>
                                E|I
                            </th>
                            <!-- <th>
                                <span title="Help" onclick="openHelp(title='Filter', content='Filters applied to the variant.', footer='')" class="w3-opacity-max w3-hover-opacity" style="cursor:pointer">
                                    <i class="fas fa-question-circle w3-tiny"></i>
                                </span>
                                Filter
                            </th> -->
                            {% for c in sample.caller %}
                                <th>
                                    <span title="Help" onclick="openHelp(title='Allelic frequencie', content='Frequence of the observed allele for the sample, and  Allelic Depth/Depth<br />Genotypes :<ul><li><i class=\'far fa-dot-circle\'></i> Mosaicism (< 0.25)</li><li><i class=\'fas fa-adjust\'></i> Heterozygous ref/alt (< 0.75)</li><li><i class=\'fas fa-circle\'></i> Homozygous alt/alt (>= 0.75)</li><li><i class=\'far fa-question-circle\'></i> Unknown status</li></ul>', footer='')" class="w3-opacity-max w3-hover-opacity" style="cursor:pointer">
                                        <i class="fas fa-question-circle w3-tiny"></i>
                                    </span>
                                    {{ c }}
                                </th>
                            {% endfor %}
                            {% for s in family_members %}
                                <th>
                                    <span title="Help" onclick="openHelp(title='{{ s }}', content='Frequence of the observed allele for the sample, and  Allelic Depth/Depth<br />Genotypes :<ul><li><i class=\'far fa-dot-circle\'></i> Mosaicism (< 0.25)</li><li><i class=\'fas fa-adjust\'></i> Heterozygous ref/alt (< 0.75)</li><li><i class=\'fas fa-circle\'></i> Homozygous alt/alt (>= 0.75)</li><li><i class=\'far fa-question-circle\'></i> Unknown status</li></ul>', footer='')" class="w3-opacity-max w3-hover-opacity" style="cursor:pointer">
                                        <i class="fas fa-question-circle w3-tiny"></i>
                                    </span>
                                    {{ s }}
                                </th>
                            {% endfor %}
                            <th>
                                <span title="Help" onclick="openHelp(title='GnomAD', content='The Genome Aggregation Database (gnomAD) is a resource developed by an international coalition of investigators, with the goal of aggregating and harmonizing both exome and genome sequencing data from a wide variety of large-scale sequencing projects, and making summary data available for the wider scientific community.<br /> The dataset used is from release 2.1 genomes (GRCh37/hg19) spans 15,708 whole-genome sequences from unrelated individuals sequenced as part of various disease-specific and population genetic studies.', footer='For more information see : <a  href=\'https://gnomad.broadinstitute.org\' target=\'_blank\' style=\'text-decoration:underline\'><i>GnomAD website</i></a>')" class="w3-opacity-max w3-hover-opacity" style="cursor:pointer">
                                <i class="fas fa-question-circle w3-tiny"></i>
                            </span>
                                GnomAD
                            </th>
                            <!-- <th>
                                <span title="Help" onclick="openHelp(title='SEAL', content='The number of occurences for this variant among all database.', footer='')" class="w3-opacity-max w3-hover-opacity" style="cursor:pointer">
                                    <i class="fas fa-question-circle w3-tiny"></i>
                                </span>
                                SEAL
                            </th> -->
                            <th>
                                <span title="Help" onclick="openHelp(title='ClinVar', content='ClinVar clinical significance of the variant.<br /><ul><li><i class=\'fa-solid fa-star fa-2xs\'></i><i class=\'fa-solid fa-star fa-2xs\'></i><i class=\'fa-solid fa-star fa-2xs\'></i><i class=\'fa-solid fa-star fa-2xs\'></i> : practice guideline</li><li><i class=\'fa-solid fa-star fa-2xs\'></i><i class=\'fa-solid fa-star fa-2xs\'></i><i class=\'fa-solid fa-star fa-2xs\'></i><i class=\'fa-regular fa-star fa-2xs\'></i> : reviewed by expert panel</li><li><i class=\'fa-solid fa-star fa-2xs\'></i><i class=\'fa-solid fa-star fa-2xs\'></i><i class=\'fa-regular fa-star fa-2xs\'></i><i class=\'fa-regular fa-star fa-2xs\'></i> : criteria provided, multiple submitters, no conflicts</li><li><i class=\'fa-solid fa-star fa-2xs\'></i><i class=\'fa-regular fa-star fa-2xs\'></i><i class=\'fa-regular fa-star fa-2xs\'></i><i class=\'fa-regular fa-star fa-2xs\'></i> : criteria provided, conflicting interpretations or single submitter</li><li><i class=\'fa-regular fa-star fa-2xs\'></i><i class=\'fa-regular fa-star fa-2xs\'></i><i class=\'fa-regular fa-star fa-2xs\'></i><i class=\'fa-regular fa-star fa-2xs\'></i> : no assertion </li></ul><br /><ul><li><span class=\'w3-tag w3-flat-turquoise\'>Benign\Likely Benign</span></li><li><span class=\'w3-tag w3-flat-peter-river\'>Conflicting (VUS/Benign)</span></li><li><span class=\'w3-tag w3-flat-sun-flower\'>Uncertain</span></li><li><span class=\'w3-tag w3-flat-carrot\'>Conflicting (with Pathogenic)</span></li><li><span class=\'w3-tag w3-flat-alizarin\'>Pathogenic/Likely pathogenic</span></li><li><span class=\'w3-tag w3-flat-silver\'>Other</span></li></ul>', footer='For more information see : <a  href=\'https://www.ncbi.nlm.nih.gov/clinvar/docs/clinsig/\' target=\'_blank\' style=\'text-decoration:underline\'><i>ClinSig documentation</i></a>')" class="w3-opacity-max w3-hover-opacity" style="cursor:pointer">
                                    <i class="fas fa-question-circle w3-tiny"></i>
                                </span>
                                ClinVar
                            </th>
                            <!-- <th>
                                <span title="Help" onclick="openHelp(title='Transmission', content='This column represent the transmission mode following OMIM data.<br /><ul><li><b>AD</b>: Autosomal dominant</li><li><b>AR</b>: Autosomal recessive</li><li><b>DD</b>: Digenic dominant</li><li><b>DR</b>: Digenic recessive</li><li><b>IC</b>: Isolated cases</li><li><b>Mito</b>: Mitochondrial</li><li><b>MF</b>: Multifactorial</li><li><b>PAD</b>: Pseudoautosomal dominant</li><li><b>PAR</b>: Pseudoautosomal recessive</li><li><b>SMos</b>: Somatic mosaicism</li><li><b>SMut</b>: Somatic mutation</li><li><b>XL</b>: X-linked</li><li><b>XLD</b>: X-linked dominant</li><li><b>XLR</b>: X-linked recessive</li><li><b>YL</b>: Y-linked</li></ul><br /><i class=\'fas fa-question-circle w3-tiny\'></i> A question mark (?) indicates that the relationship between the phenotype and gene is provisional', footer='For more information see : <a  href=\'https://www.omim.org/\' target=\'_blank\' style=\'text-decoration:underline\'><i>OMIM</i></a>' )" class="w3-opacity-max w3-hover-opacity" style="cursor:pointer">
                                <i class="fas fa-question-circle w3-tiny"></i>
                                </span>
                                Transmission
                            </th> -->
                            <th>
                                <span title="Help" onclick="openHelp(title='Impact', content='IMPACT is calculated by VEP, based on consequences and compatibility with snpEff. <div class=\'w3-flash w3-warning\'><p>Impact categories must be used with care, they were created only to help and simplify the filtering process. Obviously, there is no way to predict whether a HIGH impact or a LOW impact variant is the one producing a phenotype of interest.</p></div>', footer='For more information see : <a  href=\'https://m.ensembl.org/info/genome/variation/prediction/predicted_data.html\' target=\'_blank\' style=\'text-decoration:underline\'><i>VEP documentation</i></a> & <a  href=\'https://pcingola.github.io/SnpEff/se_inputoutput/#impact-prediction\' target=\'_blank\' style=\'text-decoration:underline\'><i>snpEff documentation</i></a>')" class="w3-opacity-max w3-hover-opacity" style="cursor:pointer">
                                    <i class="fas fa-question-circle w3-tiny"></i>
                                </span>
                                Impact
                            </th>
                            <!-- <th>
                                <span title="Help" onclick="openHelp(title='Consequence', content='Consequences are calculated by VEP following SO terms.', footer='For more information see : <a  href=\'https://m.ensembl.org/info/genome/variation/prediction/predicted_data.html\' target=\'_blank\' style=\'text-decoration:underline\'><i>VEP documentation</i></a>')" class="w3-opacity-max w3-hover-opacity" style="cursor:pointer">
                                    <i class="fas fa-question-circle w3-tiny"></i>
                                </span>
                                Consequence
                            </th> -->
                            <!-- <th>
                                <span title="Help" onclick="openHelp(title='MaxEntScan', content='Algorithms for derivation and scoring of constrained-marginal maximum entropy distributions, with applications to 5\' and 3\' splice sites. <br />We suggest this cutoff: <br /><ul><li class=\'w3-text-flat-pomegranate\'>|percent variation| &ge; 15\%</li></ul>', footer='For more information see : <a  href=\'https://github.com/guillermomarco/VEP_plugins/blob/master/MaxEntScan.pm\' target=\'_blank\' style=\'text-decoration:underline\'><i>VEP MES plugin</i></a> & <a  href=\'https://github.com/esebesty/maxentscan\' target=\'_blank\' style=\'text-decoration:underline\'><i>MaxEntScan</i></a>')" class="w3-opacity-max w3-hover-opacity" style="cursor:pointer">
                                    <i class="fas fa-question-circle w3-tiny"></i>
                                </span>
                                MaxEnt
                            </th> -->
                            <th>
                                <span title="Help" onclick="openHelp(title='SpliceAI DeltaScore', content='Delta score (DS) of a variant, defined as the maximum of ranges from 0 to 1 and can be interpreted as the probability of the variant being splice-altering. The author-suggested cutoffs are: <br /><ul><li class=\'w3-text-flat-sun-flower\'>0.2 (high recall)</li><li class=\'w3-text-flat-orange\'>0.5 (recommended)</li><li class=\'w3-text-flat-pomegranate\'>0.8 (high precision)</li></ul>', footer='For more information see : <a  href=\'https://github.com/Ensembl/VEP_plugins/blob/release/104/SpliceAI.pm\' target=\'_blank\' style=\'text-decoration:underline\'><i>VEP plugins spliceAI</i></a>')" class="w3-opacity-max w3-hover-opacity" style="cursor:pointer">
                                    <i class="fas fa-question-circle w3-tiny"></i>
                                </span>
                                SpliceAI
                            </th>
                            <th>
                                <span title="Help" onclick="openHelp(title='Missense', content='This score represents the mean rank scores of the top 10 missense predictions tools from dbNSFP v4.<br /><ul><li>CADD</li><li>VEST4</li><li>MetaSVM</li><li>MetaLR</li><li>Eigen</li><li>Eigen-PC</li><li>REVEL</li><li>BayesDel_addAF</li><li>BayesDel_noAF</li><li>ClinPred</li></ul><br />The threshold are : <ul><li><span class=\'w3-tag w3-flat-pomegranate\'>0.95</span> <i>top 5% deleteriousness of all missense variant</i></li><li><span class=\'w3-text-flat-pomegranate\'>0.9</span> <i>top 10% deleteriousness of all missense variant</i></li><li><span class=\'w3-text-flat-orange\'>0.75</span> <i>top 25% deleteriousness of all missense variant</i></li><li><span class=\'w3-text-flat-sun-flower\'>0.5</span> <i>top 50% deleteriousness of all missense variant</i></li></ul>', footer='For more information see : <a  href=\'https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7709417/\' target=\'_blank\' style=\'text-decoration:underline\'><i>dbNSFP v4</i></a>')" class="w3-opacity-max w3-hover-opacity" style="cursor:pointer">
                                    <i class="fas fa-question-circle w3-tiny"></i>
                                </span>
                                Missense
                            </th>
                            <!-- <th>
                                R
                            </th> -->
                            <th style="padding:10px 10px 6px 10px!important">
                                <span title="Help" onclick="openHelp(title='Class', content='You can choose the classification:<ul><li class=\'w3-text-flat-green-sea\'>Benign</li><li class=\'w3-text-flat-nephritis\'>Likely Benign</li><li class=\'w3-text-flat-belize-hole\'>VUS</li><li class=\'w3-text-flat-pumpkin\'>Likely Pathogenic</li><li class=\'w3-text-flat-pomegranate\'>Pathogenic</li></ul>', footer='For more information see : <a  href=\'https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4544753/\' target=\'_blank\' style=\'text-decoration:underline\'><i>ACMG guidelines</i></a>')" class="w3-opacity-max w3-hover-opacity" style="cursor:pointer">
                                    <i class="fas fa-question-circle w3-tiny"></i>
                                </span>
                                Class
                            </th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        <div class="w3-container w3-center">
            <hr>
        </div>

        <div class="w3-container w3-padding">
            <div id="comments_sample" class=" w3-container w3-border-right">
                <h2><i class="w3-text-flat-green-sea w3-xxlarge fas fa-comment"></i> Comments (<span class="commentsCountSample">{{ sample.comments | length }}</span>)</h2>

                <div id="commentsTableSample" class="w3-small">
                    <table id="tableCommentsSample" class="display" style="width:100%">
                        <thead>
                            <tr>
                                <th class="no-sort" style="width:20%">User</th>
                                <th class="no-sort" style="width:60%">Comment</th>
                                <th style="width:20%">Date</th>
                            </tr>
                        </thead>
                    </table>
                </div>

                {{ form.hidden_tag() }}
                <div class="w3-row w3-section">
                    <div class="w3-rest">
                        {% if form.comment.errors %}
                            {{ form.comment(class="w3-input w3-border w3-border-red") }}
                            <div class="w3-small w3-text-flat-alizarin">
                                {% for error in form.comment.errors %}
                                    <i class="fas fa-exclamation-circle"></i> {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ form.comment(id="comment_sample", class="w3-input w3-border") }}
                        {% endif %}
                    </div>
                </div>

                <div class="w3-section w3-center">
                    {{ form.submit(id="submitCommentSample", class="w3-button w3-flat-green-sea w3-hover-flat-turquoise", onclick="send_comment();") }}
                </div>
            </div>
        </div>
        <div class="w3-container w3-center">
            <hr>
        </div>
    </div>

    <!-- MODALS -->
    <div id="filter-modal" class="w3-modal">
        <div class="w3-modal-content w3-card-4">
            <header class="w3-container w3-flat-green-sea">
                <span onclick="$('#filter-modal').toggle()"
                    class="w3-button w3-display-topright">&times;</span>
                <h5 id="filter-modal-title">Save Filter</h5>
            </header>
            <div class="w3-container">
                {{ saveFilterForm.hidden_tag() }}
                <div class="w3-row w3-section">
                    <div class="w3-col w3-display-container w3-text-flat-green-sea w3-margin-right" style="width:50px"><i class="w3-xxlarge fas fa-tag"></i></div>
                    <div class="w3-rest">
                        {% if saveFilterForm.filterName.errors %}
                            {{ saveFilterForm.filterName(class="w3-input w3-border w3-border-red") }}
                            <div class="w3-small w3-text-flat-alizarin">
                                {% for error in saveFilterForm.filterName.errors %}
                                    <i class="fas fa-exclamation-circle"></i> {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ saveFilterForm.filterName(class="w3-input w3-border") }}
                        {% endif %}
                    </div>
                </div>

                <div class="w3-row w3-section w3-display-container">
                    <div class="w3-middle w3-col w3-display-container w3-text-flat-green-sea w3-margin-right" style="width:50px"><i class="w3-xxlarge fas fa-users"></i></div>
                    <div class="w3-rest" id="create-filter">
                        {{ saveFilterForm.teams(class="js-example-basic-multiple", multiple="multiple", style="width:100%") }}
                    </div>
                </div>
                <div class="w3-row w3-section">
                    <div class="w3-col w3-display-container w3-text-flat-green-sea w3-margin-right" style="width:50px"><i class="w3-xxlarge fas fa-filter"></i></div>
                    <div class="w3-rest">
                        {% if saveFilterForm.filterText.errors %}
                            {{ saveFilterForm.filterText(class="w3-input w3-border w3-border-red") }}
                            <div class="w3-small w3-text-flat-alizarin">
                                {% for error in saveFilterForm.filterText.errors %}
                                    <i class="fas fa-exclamation-circle"></i> {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ saveFilterForm.filterText(class="w3-input w3-border", disabled=True) }}
                        {% endif %}
                    </div>
                </div>

                <div class="w3-section w3-center">
                    {{ saveFilterForm.submit(id="validateSaveFilter", class="w3-button w3-flat-green-sea w3-hover-flat-turquoise", onclick="saveFilter();") }}
                </div>
            </div>
            <footer class="w3-container w3-light-grey w3-padding">
                <button class="w3-button w3-right w3-white w3-border"
                onclick="$('#filter-modal').toggle()">Close</button>
            </footer>
        </div>
    </div>

    <div id="modal-details-variant" class="w3-modal">
        <div class="w3-modal-content w3-card-4 w3-animate-zoom">
            <header class="w3-container w3-flat-green-sea">
                <span onclick="$('#modal-details-variant').toggle()"
                class="w3-button w3-xlarge w3-display-topright">&times;</span>
                <h2>Variant : <span id="variant-id"><span></h2>
            </header>

            <div class="w3-bar w3-border-bottom">
                <button class="tablink w3-bar-item w3-button" onclick="openDetails(event, 'allTranscripts')">Transcripts</button>
                <button class="tablink w3-bar-item w3-button" onclick="openDetails(event, 'missense')">Missense</button>
                <button class="tablink w3-bar-item w3-button" onclick="openDetails(event, 'conservation')">Conservation</button>
                <button class="tablink w3-bar-item w3-button" onclick="openDetails(event, 'population')">Population</button>
                <button class="tablink w3-bar-item w3-button" onclick="openDetails(event, 'splicing')">Splicing</button>
                <button class="tablink w3-bar-item w3-button" onclick="openDetails(event, 'links')">Links</button>
                <button class="tablink w3-bar-item w3-button" onclick="openDetails(event, 'inseal')">In Seal (<span class="inSealCount"></span>)</button>
                <button class="tablink w3-bar-item w3-button" onclick="openDetails(event, 'comments')">Comments (<span class="commentsCountVar"></span>)</button>
            </div>

            <div id="allTranscripts" class="w3-container detail">
                <h3>Transcripts</h3>
                <div id="allTranscriptsTable"></div>
            </div>

            <div id="missense" class="w3-container detail">
                <h3>Missense</h3>
                <div class="w3-row">
                    <div id='radarMissense' class="w3-col l6 m12 s12"><!-- Plotly chart will be drawn inside this DIV --></div>
                    <div class="w3-col l6 m12 s12">
                        <div id="tableScoresPredictions"></div>
                    </div>
                </div>
            </div>

            <div id="conservation" class="w3-container detail">
                <h3>Conservation</h3>
                <div class="w3-row">
                    <div id='radarConservation' class="w3-col l6 m12 s12"><!-- Plotly chart will be drawn inside this DIV --></div>
                    <div class="w3-col l6 m12 s12">
                        <div id="tableScoresConservation"></div>
                    </div>
                </div>
            </div>

            <div id="population" class="w3-container detail">
                <h3>Population</h3>
                <div class="w3-row">
                    <div id='barPopulation' class=""><!-- Plotly chart will be drawn inside this DIV --></div>
                </div>
            </div>

            <div id="splicing" class="w3-container detail">
                <h3>Splicing</h1>
                <div class="w3-row">
                    <div id='chartSplicing' class="w3-col l3 m6 s6"><!-- Plotly chart will be drawn inside this DIV --></div>
                </div>
            </div>

            <div id="links" class="w3-container detail">
                <h3>Links</h3>
                <div id="links_exterior" style="column-count: 3;"></div>
                <div class="w3-padding w3-display-bottommiddle w3-tiny">
                    <span><i class="w3-text-flat-asbestos fas fa-flag"></i> dbSNP</span>
                    <span><i class="w3-text-flat-amethyst fas fa-disease"></i> Cosmic</span>
                    <span><i class="w3-text-flat-belize-hole fas fa-user-md"></i> ClinVar</span>
                    <span><i class="w3-text-flat-pomegranate fas fa-microscope"></i> UniProt</span>
                    <span><i class="w3-text-flat-wet-asphalt fas fa-book"></i> PubMed</span>
                </div>
            </div>

            <div id="inseal" class="w3-container detail">
                <h3>In Seal (<span class="inSealCount"></span>)</h3>
                <div id="inSEALTable"></div>
            </div>

            <div id="comments" class="w3-container detail">
                <h3>Comments (<span class="commentsCountVar"></span>)</h3>

                {{ form.hidden_tag() }}
                <div class="w3-row w3-section">
                    <div class="w3-col w3-display-container w3-text-flat-green-sea w3-margin-right" style="width:50px"><i class="w3-xxlarge fas fa-comment"></i></div>
                    <div class="w3-rest">
                        {% if form.comment.errors %}
                            {{ form.comment(class="w3-input w3-border w3-border-red") }}
                            <div class="w3-small w3-text-flat-alizarin">
                                {% for error in form.comment.errors %}
                                    <i class="fas fa-exclamation-circle"></i> {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ form.comment(id="commentVar", class="w3-input w3-border") }}
                        {% endif %}
                    </div>
                </div>

                <div class="w3-section w3-center">
                    {{ form.submit(id="submitComment", class="w3-button w3-flat-green-sea w3-hover-flat-turquoise", onclick="send_comment(type='var');") }}
                </div>
                <div id="commentsTableVar"></div>
            </div>

            <div class="w3-container w3-light-grey w3-padding">
                <button class="w3-button w3-right w3-white w3-border"
                onclick="$('#modal-details-variant').toggle()">Close</button>
            </div>
        </div>
    </div>

{% endblock %}


{% block script %}
    <script type="text/javascript" src="{{ url_for('static', filename='jquery-ui/jquery-ui.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='plotly-2.3.1.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='sweetalert/sweetalert2.min.js') }}"></script>
    <script src="{{ url_for('static', filename='select2/js/select2.full.min.js') }}"></script>
    <script src="{{ url_for('static', filename='DOMPurify/purify.min.js') }}"></script>

    <script type="text/javascript">
        var sample_filter_id = "{{ sample.filter_id }}";
        var current_user_filter_id = "{{ current_user.filter_id }}";
        var sample_bed_id = "{{ sample.bed_id }}";
        var current_user_bed_id = "{{ current_user.bed_id }}";
        var sample_variants_length = "{{ sample.variants | length  }}";
        var count_hide = "{{ count_hide }}";
        var json_variants = '/json/variants/sample/{{ sample.id }}{% if sample.bed_id %}/bed/{{ sample.bed_id }}{% endif %}';
        var sample_id = "{{ sample.id }}";
        var current_user_api_key_md = "{{ current_user.api_key_md }}";
        var current_user_transcripts = "{{ current_user.transcripts |Â safe }}";
        var sample_status = "{{ sample.status }}";
        var disabled_class = "{% if sample.status == 4 %}w3-disabled {% endif %}";
        const clinvar_stars = {
            'no_assertion_criteria_provided' : 0,
            'no_assertion_provided' : 0,
            'no_interpretation_for_the_single_variant' : 0,
            'criteria_provided_single_submitter' : 1,
            'criteria_provided_conflicting_classifications' : 1,
            'criteria_provided_conflicting_interpretations' : 1,
            'criteria_provided_multiple_submitters_no_conflicts' : 2,
            'reviewed_by_expert_panel' : 3,
            'practice_guideline' : 4
        };
        var MISSENSES = [
            "CADD_raw_rankscore_hg19",
            "VEST4_rankscore",
            "MetaSVM_rankscore",
            "MetaLR_rankscore",
            "Eigen-raw_coding_rankscore",
            "Eigen-PC-raw_coding_rankscore",
            "REVEL_rankscore",
            "BayesDel_addAF_rankscore",
            "BayesDel_noAF_rankscore",
            "ClinPred_rankscore"
        ];
        // Utility functions
        const formatNA = (value, defaultValue = "NA") => value == null ? defaultValue : value;
        const formatNAHtml = (value, tag = "i") => value == null ? `<${tag}>NA</${tag}>` : value;

        const getAllelicFrequencyInfo = (data, callerKey) => {
            if (!(callerKey in data.caller)) return null;

            const callerData = data.caller[callerKey];
            let final = "";

            if (callerData.allelic_frequency >= 0 && callerData.allelic_frequency < 0.25) {
                final += "[MOS]\n";
            } else if (callerData.allelic_frequency < 0.75) {
                final += "[HTZ]\n";
            } else if (callerData.allelic_frequency <= 1) {
                final += "[HOM]\n";
            }

            final += JSON.stringify(callerData.filter) + "\n";

            if (callerData.allelic_frequency) {
                final += `Allelic frequency: ${(callerData.allelic_frequency * 100).toFixed(2)}% \n`;
            }

            if (callerData.allelic_depth && callerData.depth) {
                final += `Depth (var/total): ${callerData.allelic_depth}/${callerData.depth}\n`;
            }

            return final;
        };

        const createColumn = (config) => {
            const {
                id,
                className = '',
                data,
                defaultContent,
                title,
                exportTitle,
                renderConfig = {},
                myTitleFn,
                searchBuilderTitle,
                exportTitleDefGen,
                searchBuilder,
                type,
                sType,
                orderable = true,
                visible = true
            } = config;

            const column = {
                id,
                className: `showTitle w3-tiny ${className}`.trim(),
                data,
                orderable,
                visible
            };

            if (exportTitle) { column.exportTitle = exportTitle } 
                else if (searchBuilderTitle) { column.exportTitle = searchBuilderTitle } 
                else if (exportTitleDefGen) { column.exportTitle = exportTitleDefGen } 
                else { column.exportTitle = id };
            if (exportTitleDefGen) column.exportTitleDefGen = exportTitleDefGen;
            if (defaultContent) column.defaultContent = defaultContent;
            if (myTitleFn) column.mytitle = myTitleFn;
            if (searchBuilderTitle) column.searchBuilderTitle = searchBuilderTitle;
            if (type) column.type = type;
            if (searchBuilder) column.searchBuilder = searchBuilder;
            if (sType) column.sType = sType;

            // Set up render functions
            column.render = {
                _: renderConfig.default || ((d) => d),
                ...(renderConfig.display && { display: renderConfig.display }),
                ...(renderConfig.sort && { sort: renderConfig.sort }),
                ...(renderConfig.filter && { filter: renderConfig.filter })
            };

            return column;
        };
        var dt_table = [
            // SYMBOL Column
            createColumn({
                id: "visible-SYMBOL",
                title: "GENE",
                data: "annotations",
                myTitleFn: (data) => formatNA(data.SYMBOL),
                renderConfig: {
                    default: (data) => {
                        return data.SYMBOL
                    },
                    display: (data) => {
                        return data.SYMBOL == null
                        ? "<i>NA</i>"
                        : `<div class="w3-middle w3-container w3-cell" style="vertical-align: middle;padding: 0px !important;">
                                <p style="width: 75px;margin:0;word-break: break-word;white-space: normal;"><b>${data.SYMBOL}</b></p>
                            </div>`
                    }
                }
            }),
            // Nomenclature Column
            createColumn({
                id: "visible-Nomenclature",
                data: null,
                className: 'w3-border-right',
                myTitleFn: (data) => {
                    if (data.annotations == null) return "<i>NA</i>";

                    let response = data.annotations.preferred ? " (selected)" : "";
                    response += data.annotations.canonical ? " (canonical)" : "";

                    const HGVSg = formatNA(data.annotations.HGVSg, "NA");
                    const HGVSc = formatNA(data.annotations.HGVSc, "NA");
                    const HGVSp = formatNA(data.annotations.HGVSp, "NA");

                    return `${HGVSg}\n${HGVSc}${response}\n${HGVSp}`;
                },
                renderConfig: {
                    display: (data) => {
                        if (data.annotations == null) return "<i>NA</i>";
                        const genome = "{{ genome_version }}".toLowerCase() == "grch38" ? "hg38" : "hg19";
                        const mobidetails = (current_user_api_key_md !== "None") ? `<a target="_blank" title="MobiDetails" href="https://mobidetails.chu-montpellier.fr/api/variant/create?variant_chgvs=${encodeURIComponent(data.annotations.HGVSc)}&caller=browser&api_key=${current_user_api_key_md}" class="w3-text-flat-peter-river w3-hover-text-flat-carrot do-not-select" style="cursor: pointer;"><span class="fa-layers fa-fw do-not-select">
                            <span class="fa-layers do-not-select">
                                <i class="fa-solid fa-square do-not-select" data-fa-transform="grow-11"></i>
                                <span class="fa-layers-text fa-inverse do-not-select" data-fa-transform="shrink-3" style="font-weight:900">MD</span>
                            </span>
                        </span></a><br />` : "";
                        const genebe = `<a target="_blank" title="GeneBe" href="https://genebe.net/variant/${genome}/${data.annotations.HGVSg}" class="w3-text-flat-emerald w3-hover-text-flat-pumpkin do-not-select" style="cursor: pointer;"><span class="fa-layers fa-fw do-not-select">
                            <span class="fa-layers do-not-select">
                                <i class="fa-solid fa-square do-not-select" data-fa-transform="grow-11"></i>
                                <span class="fa-layers-text fa-inverse do-not-select" data-fa-transform="shrink-3" style="font-weight:900">GB</span>
                            </span>
                        </span></a><br />`;
                        const franklin = `<a target="_blank" title="Franklin" href="https://franklin.genoox.com/clinical-db/variant/snp/${data.id}-${genome}" class="w3-text-flat-midnight-blue w3-hover-text-flat-turquoise do-not-select" style="cursor: pointer;"><span class="fa-layers fa-fw do-not-select">
                            <span class="fa-layers do-not-select">
                                <i class="fa-solid fa-square do-not-select" data-fa-transform="grow-11"></i>
                                <span class="fa-layers-text fa-inverse do-not-select" data-fa-transform="shrink-3" style="font-weight:900">F</span>
                            </span>
                        </span></a>`;

                        const color = data.annotations.preferred ? "w3-text-flat-peter-river" : "";
                        const starIcon = data.annotations.canonical
                            ? `<i class="${color} fas fa-star w3-tiny"></i>`
                            : `<i class="${color} far fa-star w3-tiny"></i>`;

                        return `
                            <div class="w3-cell-row" style="margin-left:-10px;">
                                <div class="w3-center w3-container w3-cell" style="vertical-align: middle;width:20px;padding: 0px !important;">
                                    ${starIcon}
                                </div>
                                <div class="w3-container w3-cell" style="padding: 0px !important;">
                                    <p style="width: 180px;margin:0;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;">${formatNA(data.annotations.HGVSg, "<i>NA</i>")}</p>
                                    <p style="width: 180px;margin:0;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;">${formatNA(data.annotations.HGVSc, "<i>NA</i>")}</p>
                                    <p style="width: 180px;margin:0;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;">${formatNA(data.annotations.HGVSp, "<i>NA</i>")}</p>
                                </div>
                                <div class="w3-center w3-container w3-cell" style="vertical-align: middle;padding: 0px !important;">
                                    ${mobidetails}${genebe}${franklin}
                                </div>
                            </div>
                        `;
                    },
                    sort: (data) => {
                        if (!data.annotations || !data.annotations.HGVSg) return -1;

                        const matches = data.annotations.HGVSg.match(/(chr|cen|pter|qter|sup)?([0-9XYMt]+):[gmno]\.([0-9]+)(_[0-9]+)?([ACGT]+>)?(dup|ins|del|inv|[ACGT]+)?/);
                        if (!matches) return -1;

                        const zero = "000000000";
                        let chr = matches[2];

                        if (Number.isInteger(parseInt(chr))) {
                            chr = (zero + chr).slice(-2);
                        } else {
                            if (/^[Mm](t)?$/.test(chr)) chr = "25";
                            else if (/^[Yy]$/.test(chr)) chr = "24";
                            else if (/^[Xx]$/.test(chr)) chr = "23";
                        }

                        return `${chr}_${(zero + matches[3]).slice(-9)}_${matches[6] || ''}`;
                    }
                }
            }),
            // EI Column
            createColumn({
                id: "visible-EI",
                data: "annotations",
                className: 'w3-border-right w3-center',
                myTitleFn: (data) => {
                    if (data.EXON != null) return `Exon ${data.EXON}`;
                    if (data.INTRON != null) return `Intron ${data.INTRON}`;
                    return "NA";
                },
                renderConfig: {
                    default: (data) => {
                        if (data.EXON != null) return `Exon ${data.EXON}`;
                        if (data.INTRON != null) return `Intron ${data.INTRON}`;
                        return "NA";
                    },
                    display: (data) => {
                        if (data.EXON != null) return `<b>Exon ${data.EXON}</b>`;
                        if (data.INTRON != null) return `<i>Intron ${data.INTRON}</i>`;
                        return "<i>NA</i>";
                    },
                    sort: (data) => {
                        const ei = data.EXON != null ? data.EXON : (data.INTRON != null ? data.INTRON : "NA");
                        return ei.toString().split(/\//)[0];
                    }
                }
            }),
            // Variant Caller Columns (generated from template)
            {% for c in sample.caller %}
            createColumn({
                id: "variant_caller_{{ loop.index }}",
                data: null,
                className: "{% if loop.last %}w3-border-right{% endif %}",
                myTitleFn: (data) => getAllelicFrequencyInfo(data, "{{ c }}"),
                renderConfig: {
                    default: (data) => {
                        if (!("{{ c }}" in data.caller)) return "NA";
                        return data.caller["{{ c }}"].allelic_frequency;
                    },
                    display: (data) => {
                        if (!("{{ c }}" in data.caller)) return "<i>NA</i>";

                        const callerData = data.caller["{{ c }}"];
                        const af = callerData.allelic_frequency;
                        const filterIcon = JSON.stringify(callerData.filter) === JSON.stringify(["PASS"])
                            ? '<i class="fas fa-flag w3-text-flat-green-sea"></i>'
                            : '<i class="fas fa-flag w3-text-flat-pomegranate"></i>';

                        let icon;
                        if (af >= 0 && af < 0.25) {
                            icon = '<i class="far fa-dot-circle w3-tiny"></i>';
                        } else if (af < 0.75) {
                            icon = '<i class="fas fa-adjust w3-tiny"></i>';
                        } else if (af <= 1) {
                            icon = '<i class="fas fa-circle w3-tiny"></i>';
                        } else {
                            return `<i>${af}</i>`;
                        }

                        return `${icon} ${(af * 100).toFixed(2)}% <br />${filterIcon} ${callerData.allelic_depth}/${callerData.depth}`;
                    },
                    sort: (data) => {
                        if (!("{{ c }}" in data.caller)) return -1;
                        return data.caller["{{ c }}"].allelic_frequency;
                    }
                }
            }),
            {% endfor %}
            // Family Member Columns (generated from template)
            {% for s in family_members %}
            createColumn({
                id: "family_{{ loop.index }}",
                data: "family",
                className: "{% if loop.last %}w3-border-right{% endif %}",
                myTitleFn: (data) => {
                    const family = data["{{ s }}"];
                    if (!family) return null;

                    let af;
                    if (isNaN(parseFloat(family.allelic_frequency))) {
                        if (!isNaN(family.allelic_depth) && !isNaN(family.depth)) {
                            af = family.allelic_depth / family.depth;
                        } else {
                            return null;
                        }
                    } else {
                        af = parseFloat(family.allelic_frequency);
                    }

                    let final = "";
                    if (af >= 0 && af < 0.25) final += "[MOS]\n";
                    else if (af < 0.75) final += "[HTZ]\n";
                    else if (af <= 1) final += "[HOM]\n";
                    else return null;

                    final += `${JSON.stringify(family.filter)}\n`;
                    if (!isNaN(af)) final += `Allelic frequency: ${(af * 100).toFixed(2)}% \n`;
                    if (family.allelic_depth && family.depth) final += `Depth (var/total): ${family.allelic_depth}/${family.depth}\n`;

                    return final;
                },
                renderConfig: {
                    default: (data) => {
                        const family = data["{{ s }}"];
                        if (!family) return null;

                        if (isNaN(parseFloat(family.allelic_frequency))) {
                            if (!isNaN(family.allelic_depth) && !isNaN(family.depth)) {
                                return family.allelic_depth / family.depth;
                            }
                            return null;
                        }
                        return parseFloat(family.allelic_frequency);
                    },
                    display: (data) => {
                        const family = data["{{ s }}"];
                        if (!family) return "<i>NA</i>";

                        let af;
                        if (isNaN(parseFloat(family.allelic_frequency))) {
                            if (!isNaN(family.allelic_depth) && !isNaN(family.depth)) {
                                af = family.allelic_depth / family.depth;
                            } else {
                                return "<i>NA</i>";
                            }
                        } else {
                            af = parseFloat(family.allelic_frequency);
                        }

                        const filterIcon = JSON.stringify(family.filter) === JSON.stringify(["PASS"])
                            ? '<i class="fas fa-flag w3-text-flat-green-sea"></i>'
                            : '<i class="fas fa-flag w3-text-flat-pomegranate"></i>';

                        let icon;
                        if (af >= 0 && af < 0.25) icon = '<i class="far fa-dot-circle w3-tiny"></i>';
                        else if (af < 0.75) icon = '<i class="fas fa-adjust w3-tiny"></i>';
                        else if (af <= 1) icon = '<i class="fas fa-circle w3-tiny"></i>';

                        return `${icon} ${Math.round(af * 100)}% <br />${filterIcon} ${family.allelic_depth}/${family.depth}`;
                    }
                }
            }),
            {% endfor %}
            // gnomAD Column
            createColumn({
                id: "visible-gnomad",
                data: null,
                className: 'w3-border-right',
                myTitleFn: (data) => {
                    const gnomad = parseFloat(data.annotations?.gnomADg_AF);
                    if (isNaN(gnomad)) return "NA";

                    const pop = {
                        "gnomADg_AF_AFR": "African/African-American",
                        "gnomADg_AF_AMR": "Admixed American",
                        "gnomADg_AF_ASJ": "Ashkenazi Jewish",
                        "gnomADg_AF_EAS": "East Asian",
                        "gnomADg_AF_FIN": "Finnish",
                        "gnomADg_AF_NFE": "Non-Finnish European",
                        "gnomADg_AF_OTH": "Remaining individuals"
                    };

                    let max = -1;
                    let p = '';
                    let popKey = '';

                    for (const [key, label] of Object.entries(pop)) {
                        const v = parseFloat(data.annotations?.[key]);
                        if (!isNaN(v) && v > max) {
                            max = v;
                            popKey = key;
                        }
                    }

                    if (popKey) {
                        const fixed = max > 0 ? Math.min(Math.max(-Math.floor(Math.log10(max * 100)), 2), 5) : 2;
                        const v = (max * 100).toFixed(fixed);
                        p = `\nMax: ${v}% - (${pop[popKey]})`;
                    }

                    const fixed = max > 0 ? Math.min(Math.max(-Math.floor(Math.log10(max * 100)), 2), 5) : 2;
                    return `${(gnomad * 100).toFixed(fixed)}%${p}`;
                },
                renderConfig: {
                    default: (data) => {
                        const gnomad = parseFloat(data.annotations?.gnomADg_AF);
                        return isNaN(gnomad) ? null : gnomad;
                    },
                    display: (data) => {
                        const gnomad = parseFloat(data.annotations?.gnomADg_AF);
                        const seal = `<b><span class="w3-text-flat-green-sea"><span class="icon-seal"></span> SEAL: </span>${data.inseal?.occurrences || ''}</b>`;
                        if (isNaN(gnomad)) return `<i>NA</i><br />${seal}`;

                        const pop = {
                            "gnomADg_AF_AFR": "AFR",
                            "gnomADg_AF_AMR": "AMR",
                            "gnomADg_AF_ASJ": "ASJ",
                            "gnomADg_AF_EAS": "EAS",
                            "gnomADg_AF_FIN": "FIN",
                            "gnomADg_AF_NFE": "NFE",
                            "gnomADg_AF_OTH": "OTH"
                        };

                        let max = -1;
                        let pmax = '';
                        for (const [key, label] of Object.entries(pop)) {
                            const v = parseFloat(data.annotations?.[key]);
                            if (!isNaN(v) && v > max) {
                                max = v;
                                pmax = `<br /><i><i class="fa-solid fa-angles-up w3-text-flat-nephritis"></i> ${label}: ${v > 0.01 ? v.toFixed(4) : v.toExponential(2)}</i>`;
                            }
                        }

                        const response = gnomad > 0.01 ? gnomad.toFixed(4) : gnomad.toExponential(2);

                        {% if genome_version == "grch37" %}
                        const gnomad_version = "r2_1";
                        const ext_exac = "?dataset=exac";
                        const ext_r2_1 = "?dataset=gnomad_r2_1";
                        const ext_r3 = "/gnomad_r2_1/gnomad_r3";
                        const ext_r4 = "/gnomad_r2_1/gnomad_r4";
                        const liftover_exac = "";
                        const liftover_r2_1 = "";
                        const liftover_r3 = "liftover/";
                        const liftover_r4 = "liftover/";
                        {% else %}
                        const gnomad_version = "r4";
                        const ext_exac = "/gnomad_r4/exac";
                        const ext_r2_1 = "/gnomad_r4/gnomad_r2_1";
                        const ext_r3 = "?dataset=gnomad_r3";
                        const ext_r4 = "?dataset=gnomad_r4";
                        const liftover_exac = "liftover/";
                        const liftover_r2_1 = "liftover/";
                        const liftover_r3 = "";
                        const liftover_r4 = "";
                        {% endif %}

                        const gnomad_r = `<a target="_blank" href="https://gnomad.broadinstitute.org/variant/${data.id}?dataset=gnomad_${gnomad_version}" class="fa-fw w3-text-indigo w3-hover-text-black do-not-select" style="cursor: pointer;">${response}</a>`;

                        return `<i title="${gnomad}">${gnomad_r}</i> (${gnomad_version})${pmax}<br />${seal}`;
                    },
                    sort: (data) => {
                        const gnomad = parseFloat(data.annotations?.gnomADg_AF);
                        if (gnomad == null) return -1;
                        if (isNaN(gnomad)) return -0.5;
                        return gnomad;
                    }
                }
            }),
            // ClinVar Column
            createColumn({
                id: "visible-clinvar",
                data: null,
                className: 'w3-border-right',
                myTitleFn: (data) => {
                    const clinvar = data.clinvar || {};
                    const phenotypes = data.phenotypes || {};
                    const star = (clinvar.CLNREVSTAT == null) ? 0 : clinvar_stars[clinvar.CLNREVSTAT];
                    let stat = '';
                    if (clinvar.CLNREVSTAT) {
                        stat = ` (${star}/4)`;
                    }

                    const inheritancesArray = Object.entries(phenotypes).map(([_, pheno]) => {
                        const inh = pheno.inheritances?.replace(/\[|\]|"|'|\s*/g, '')?.split(',') || [];
                        let t = `${inh.join(',')} - ${pheno.phenotype}`;
                        t = t.length > 50 ? `${t.substring(0, 47).trimEnd()}...` : t;
                        return t;
                    });

                    return `${clinvar.CLNSIG || ''}${stat}\n${inheritancesArray.join("\n")}`;
                },
                renderConfig: {
                    default: (data) => {
                        const clinvar = data.clinvar || {};
                        let stat = '';
                        if (clinvar.CLNREVSTAT) {
                            stat = ` (${clinvar_stars[clinvar.CLNREVSTAT]}/4)`;
                        }
                        return `${clinvar.CLNSIG || ''}${stat}`;
                    },
                    display: (data) => {
                        const clinvar = data.clinvar || {};
                        const phenotypes = data.phenotypes || {};
                        const omims = data.omims || '';

                        const inheritancesArray = Object.values(phenotypes)
                            .flatMap(pheno => pheno.inheritances?.replace(/\[|\]|"|'|\s*/g, '')?.split(','))
                            .filter(Boolean);

                        const uniqueInheritances = [...new Set(inheritancesArray)];

                        let clinvarHtml = "";
                        let color = 'silver';
                        let colorHover = 'concrete';

                        if (clinvar.CLNSIG) {
                            const href = clinvar.VARID ? `https://www.ncbi.nlm.nih.gov/clinvar/variation/${clinvar.VARID}` : '';

                            if (/benign/i.test(clinvar.CLNSIG)) {
                                color = "turquoise";
                                colorHover = "green-sea";
                            } else if (/uncertain/i.test(clinvar.CLNSIG)) {
                                color = "sun-flower";
                                colorHover = "orange";
                            } else if (/conflicting/i.test(clinvar.CLNSIG)) {
                                color = "peter-river";
                                colorHover = "belize-hole";
                                if (/pathogenic|establish/i.test(clinvar.CLNSIGCONF)) {
                                    color = "carrot";
                                    colorHover = "pumpkin";
                                }
                            } else if (/pathogenic|establish/i.test(clinvar.CLNSIG)) {
                                color = "alizarin";
                                colorHover = "pomegranate";
                            } 

                            let title = clinvar.CLNSIGCONF || clinvar.CLNSIG;
                            let n = 0;
                            let s = "";
                            let stat = '';

                            if (clinvar.CLNREVSTAT) {
                                n = clinvar_stars[clinvar.CLNREVSTAT];
                                stat = ` (${n}/4)`;
                                s = Array(4).fill(0).map((_, x) =>
                                    x < n ? '<i class="fa-solid fa-star fa-2xs"></i>' : '<i class="fa-regular fa-star fa-2xs"></i>'
                                ).join('');
                            }

                            const p = "<p class='do-not-select' style='width: 150px;margin:0;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;'>";
                            clinvarHtml = `<a style='text-align: justify;' href='${href}' title='${title}${stat}' class='w3-tag w3-flat-${color} w3-hover-flat-${colorHover} do-not-select' target='_blank' >${p}${s} ${clinvar.CLNSIG}</p></a>`;
                        }

                        return `${clinvarHtml}<br /><i><a class='w3-text-flat-peter-river w3-hover-flat-belize-hole do-not-select' target='_blank' href='https://www.omim.org/entry/${omims}' title='https://www.omim.org/entry/${omims}' style='padding: 0px 8px;display:inline-block'>${uniqueInheritances.sort().join(', ')}</a></i>`;
                    },
                    sort: (data) => {
                        const clinvar = data.clinvar || {};
                        let value = 2;

                        if (clinvar.CLNSIG) {
                            if (/benign/i.test(clinvar.CLNSIG)) {
                                value = 0;
                                if (/likely/i.test(clinvar.CLNSIGCONF)) value += 0.2;
                            } else if (/uncertain/i.test(clinvar.CLNSIG)) {
                                value = 3;
                            } else if (/conflicting/i.test(clinvar.CLNSIG)) {
                                value = 1;
                                if (/pathogenic|establish/i.test(clinvar.CLNSIGCONF)) {
                                    value = 4;
                                }
                            } else if (/pathogenic|establish/i.test(clinvar.CLNSIG)) {
                                value = 5;
                                if (/likely/i.test(clinvar.CLNSIGCONF)) value -= 0.2;
                            } 
                        }
                        return value;
                    }
                }
            }),
            // Impact & Consequences Column
            createColumn({
                id: "visible-impact_consequences",
                data: "annotations",
                className: 'w3-border-right',
                myTitleFn: (data) => {
                    if (!data) return null;
                    const cons = (data.Consequence || []).join("\n");
                    return `${data.IMPACT || ''}\n${cons}`;
                },
                renderConfig: {
                    default: (data) => data?.IMPACT || null,
                    display: (data) => {
                        if (!data) return "<i>NA</i>";

                        const impactColor = impact_dict[data.IMPACT]?.color || "7f8c8d";
                        const response = `<i class="fa-solid fa-circle w3-text-flat-${impactColor}"></i>`;

                        const cons = (data.Consequence || []).slice(0, 3).map((c, i) => {
                            const color = consequences_dict[c]?.color || "7f8c8d";
                            const style = `style='width: 130px;margin:0;padding: 1px 8px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;color:#${color};'`;
                            return `<p ${style}><b>${c}</b></p>`;
                        }).join('');

                        return `
                            <div class="w3-cell-row">
                                <div class="w3-center w3-container w3-cell" style="vertical-align: middle;width:20px;padding: 0px !important;">
                                    ${response}
                                </div>
                                <div class="w3-container w3-cell" style="padding: 0px !important;">
                                    ${cons}${data.Consequence?.length > 3 ? "..." : ""}
                                </div>
                            </div>
                        `;
                    },
                    filter: (data) => data?.IMPACT?.toString() || "",
                    sort: (data) => impact_dict[data?.IMPACT]?.score || 0
                },
                sType: "numeric"
            }),
            // Predictions Column
            createColumn({
                id: "visible-predictions",
                data: "annotations",
                className: 'w3-border-right',
                renderConfig: {
                    default: (data) => {
                        if (!data) return null;

                        const alt = parseFloat(data.MaxEntScan_alt || 0).toFixed(2);
                        const ref = parseFloat(data.MaxEntScan_ref || 0).toFixed(2);
                        const mes_var = (((alt - ref) / Math.abs(ref))).toFixed(2);

                        const spliceai = ["AG", "AL", "DG", "DL"]
                            .map(type => parseFloat(data[`SpliceAI_pred_DS_${type}`] || 0))
                            .filter(v => !isNaN(v));

                        const smax = Math.max(...spliceai, 0);
                        let s = 0;

                        if(!isNaN(mes_var)) {
                            if ((data.MaxEntScan_alt < 3) && (data.MaxEntScan_ref < 3)) {
                                s += Math.abs(parseFloat(mes_var)) / 6;
                            } else {
                                s += Math.abs(parseFloat(mes_var)) / 2;
                            }
                        }                        
                        if (!isNaN(smax)) s += parseFloat(smax);

                        return s;
                    },
                    display: (data) => {
                        if (!data) return "<i>NA</i>";

                        const alt = parseFloat(data.MaxEntScan_alt || 0).toFixed(2);
                        const ref = parseFloat(data.MaxEntScan_ref || 0).toFixed(2);
                        const mes_var = (((alt - ref) / Math.abs(ref)) * 100).toFixed(2);

                        let mes_pre = '';
                        let mes_post = '';
                        let mes_alt_pre = '';
                        let mes_alt_post = '';

                        if ((data.MaxEntScan_alt >= 3) || (data.MaxEntScan_ref >= 3)) {
                            mes_pre = '<b>';
                            if (Math.abs(mes_var) >= 15) {
                                mes_pre += '<span class="w3-text-flat-carrot">';
                                if (Math.abs(mes_var) >= 30) {
                                    mes_pre = '<b><span class="w3-text-flat-pomegranate">';
                                }
                                mes_post = '</span>';
                            }
                            mes_alt_pre = mes_var > 0 ? '<span class="w3-text-flat-nephritis">' : '<span class="w3-text-flat-pomegranate">';
                            mes_alt_post = '</span>';
                            mes_post += '</b>';
                        }

                        const mes = isNaN(mes_var) ? "<i>NA</i>" : `${mes_pre}${mes_var}${mes_post} <i>(${ref}|${mes_alt_pre}${alt}${mes_alt_post})</i>`;

                        // SpliceAI processing
                        const spliceai_types = ["AG", "AL", "DG", "DL"];
                        const spliceai = {};

                        spliceai_types.forEach(i => {
                            const v = parseFloat(data[`SpliceAI_pred_DS_${i}`]);
                            if (isNaN(v)) return;

                            if (!(v in spliceai)) spliceai[v] = [];
                            spliceai[v].push(i);
                        });

                        const spliceai_scores = Object.keys(spliceai)
                            .map(Number)
                            .sort((a, b) => b - a);

                        const spliceAI = spliceai_scores.length > 0
                            ? spliceai_scores.map((i, index) => {
                                let spliceai_pre = "";
                                let spliceai_post = "</span>";

                                if (i >= 0.2) spliceai_pre = '<span class="w3-text-flat-orange">';
                                if (i >= 0.5) {
                                    spliceai_pre = '<b><span class="w3-text-flat-pumpkin">';
                                    spliceai_post = "</span></b>";
                                }
                                if (i >= 0.8) spliceai_pre = '<b><span class="w3-text-flat-pomegranate">';

                                return `${index > 0 ? " | " : ""}${spliceai_pre}${i} ${spliceai[i].join(',')}${spliceai_post}`;
                            }).join('')
                            : "<i>NA</i>";

                        return `${mes}<br />${spliceAI}`;
                    }
                }
            }),
            // Missense Column
            createColumn({
                id: "visible-missense",
                data: "annotations",
                className: 'w3-border-right',
                myTitleFn: (data) => {
                    if (data?.missensesMean == null) return null;

                    const value = parseFloat(data.missensesMean);
                    const array = MISSENSES
                        .map(i => parseFloat(data[i]))
                        .filter(x => !isNaN(x));

                    const n = array.length;
                    const stdev = n > 0 ? Math.sqrt(array.map(x => Math.pow(x - value, 2)).reduce((a, b) => a + b, 0) / n) : 0;
                    const cv = stdev / value;

                    return `${value.toFixed(4)}\nstdev: ${stdev.toFixed(2)}\ncv: ${cv.toFixed(2)}`;
                },
                renderConfig: {
                    default: (data) => data?.missensesMean != null ? parseFloat(data.missensesMean).toFixed(4) : null,
                    display: (data) => {
                        if (data?.missensesMean == null) return "<i>NA</i>";

                        const value = parseFloat(data.missensesMean);
                        let classw3css = "";

                        if (value >= 0.95) classw3css = "w3-tag w3-flat-pomegranate";
                        else if (value >= 0.9) classw3css = "w3-text-flat-pomegranate";
                        else if (value >= 0.75) classw3css = "w3-text-flat-orange";
                        else if (value >= 0.5) classw3css = "w3-text-flat-sun-flower";

                        const array = MISSENSES
                            .map(i => parseFloat(data[i]))
                            .filter(x => !isNaN(x));

                        const n = array.length;
                        const stdev = n > 0 ? Math.sqrt(array.map(x => Math.pow(x - value, 2)).reduce((a, b) => a + b, 0) / n) : 0;
                        const cv = stdev / value;

                        let stdev_resp, t;
                        if (cv <= 0.15) {
                            stdev_resp = `<b><span class="w3-text-flat-nephritis">${stdev.toFixed(2)}</span></b>`;
                            t = '<b> <i class="w3-text-flat-nephritis fas fa-angles-up"></i></b>';
                        } else if (cv <= 0.3) {
                            stdev_resp = `<span class="w3-text-flat-belize-hole">${stdev.toFixed(2)}</span>`;
                            t = ' <i class="w3-text-flat-belize-hole fas fa-angle-up"></i>';
                        } else {
                            stdev_resp = `<span class="w3-text-flat-wisteria">${stdev.toFixed(2)}</span>`;
                            t = ' <i class="w3-text-flat-pomegranate fas fa-angles-down"></i>';
                        }

                        return `<b><span style='display:inline-table;' class='${classw3css}'>${value.toFixed(4)}</span></b><br /><i>stdev: ${stdev_resp}${t}`;
                    },
                    sort: (data) => data?.missensesMean != null ? parseFloat(data.missensesMean).toFixed(4) : -1
                }
            }),
            // Class Column
            createColumn({
                id: "visible-class",
                data: "class_variant",
                className: `${disabled_class} no-padding seal-form-report showTitle w3-center w3-border-right`,
                renderConfig: {
                    default: (data) => data ? data : 0,
                    display: (data, type, row) => {
                        const id_var = row.id;
                        const class_variant = data ? data : 0;

                        const dropdown = Object.entries(class_variant_html).map(([c, label]) =>
                            `<a onclick="toggle_class('${id_var}', ${sample_id}, ${c}, this)" class="do-not-select w3-bar-item w3-button" style="width:inherit">${label}</a>`
                        ).join('');
                        
                        return `
                            <div class="do-not-select w3-tiny w3-dropdown-click w3-right" style="background-color:transparent">
                                <button class="do-not-select w3-button button-class w3-left-align" onclick="toggle_dd_class('button-class-${id_var}')" style="min-width:168px;" id="button-class-${id_var}">
                                    ${class_variant_html[class_variant]}
                                </button>
                                <div class="do-not-select w3-dropdown-content w3-bar-block w3-border" style="min-width:200px" data-container="tbody" id="button-class-${id_var}-content">
                                    ${dropdown}
                                </div>
                            </div>
                        `;
                    }
                }
            }),
            // Details Column
            createColumn({
                id: "visible-details",
                data: null,
                orderable: false,
                className: 'w3-border-left details-control w3-center',
                renderConfig: {
                    default: (data) => data?.id || '',
                    display: (data, type, row) => {
                        const details = `<i onclick="openDetailsVariantModal('${data.id}', ${sample_id})" class="w3-text-flat-turquoise w3-hover-text-flat-green-sea fas fa-plus-circle" style="cursor: pointer;" title="See details"></i>`;
                        const hide = `<i onclick="hideRow('${data.id}', ${sample_id}, this)" class="w3-text-flat-pumpkin w3-hover-text-flat-carrot fas fa-eye-slash remove" style="cursor: pointer;" title="Hide row"></i>`;
                        const check = row.reported ? 'checked="checked"' : "";
                        const report = `<input id="${data.id}reported" type="checkbox" ${check} onclick="toggle_var2sample_status('${data.id}reported', '${data.id}', ${sample_id}, 'reported', this);">`;

                        return `${details}<br />${hide}<br />${report}`;
                    }
                }
            }),
            // Hiden column for export and filtering
            // SYMBOL Column
            createColumn({
                id: "export-genome",
                data: null,
                defaultContent: "{{ genome_version }}",
                exportTitle:"Genome",
                exportTitleDefGen:"GENOME_REFERENCE",
                visible: false
            }),
            createColumn({
                id: "export-filter-chr",
                data: "chr",
                searchBuilderTitle:"Chromosome",
                exportTitleDefGen:"CHROMOSOME",
                visible: false
            }),
            createColumn({
                id: "export-filter-pos",
                data: "pos",
                searchBuilderTitle:"Position",
                exportTitleDefGen:"POSITION_GENOMIQUE",
                visible: false
            }),
            createColumn({
                id: "export-filter-ref",
                data: "ref",
                searchBuilderTitle:"Ref",
                visible: false
            }),
            createColumn({
                id: "export-filter-alt",
                data: "alt",
                searchBuilderTitle:"Alt",
                visible: false
            }),
            createColumn({
                id: "export-filter-SYMBOL",
                data: "annotations.SYMBOL",
                searchBuilderTitle:"Gene",
                exportTitleDefGen:"GENE",
                visible: false
            }),
            createColumn({
                id: "export-filter-HGVSg",
                data: "annotations.HGVSg",
                searchBuilderTitle:"HGVSg",
                exportTitleDefGen:"NOMENCLATURE_HGVS",
                visible: false,
                renderConfig: {
                    default: (data) => {
                        if (data != null) return data ;
                        return "";
                    },
                },
                type:"string"
            }),
            createColumn({
                id: "export-filter-HGVSc",
                data: "annotations.HGVSc",
                searchBuilderTitle:"HGVSc",
                exportTitleDefGen:"VARIANT",
                visible: false,
                renderConfig: {
                    default: (data) => {
                        if (data != null) return data ;
                        return "";
                    },
                },
                type:"string"
            }),
            createColumn({
                id: "export-filter-HGVSp",
                data: "annotations.HGVSp",
                searchBuilderTitle:"HGVSp",
                visible: false,
                renderConfig: {
                    default: (data) => {
                        if (data != null) return data ;
                        return "";
                    },
                },
                type:"string"
            }),
            createColumn({
                id: "exportDefGen-HGVSg-short",
                data: "annotations.HGVSg",
                visible: false,
                type:"string",
                renderConfig: {
                    default: (data) => {
                        hgvs_split = String(data).split(":");
                        if (hgvs_split.length > 1) {
                            return hgvs_split[1];
                        }
                        return ""
                    },
                }
            }),
            createColumn({
                id: "exportDefGen-HGVSc-short",
                data: "annotations.HGVSc",
                exportTitleDefGen:"VARIANT_C",
                visible: false,
                type:"string",
                renderConfig: {
                    default: (data) => {
                        hgvs_split = String(data).split(":");
                        if (hgvs_split.length > 1) {
                            return hgvs_split[1];
                        }
                        return ""
                    },
                }
            }),
            createColumn({
                id: "exportDefGen-HGVSp-short",
                data: "annotations.HGVSp",
                exportTitleDefGen:"VARIANT_P",
                visible: false,
                type:"string",
                renderConfig: {
                    default: (data) => {
                        hgvs_split = String(data).split(":");
                        if (hgvs_split.length > 1) {
                            return hgvs_split[1];
                        }
                        return ""
                    },
                }
            }),
            createColumn({
                id: "export-filter-Nearest",
                data: "annotations.NEAREST",
                searchBuilderTitle:"Nearest Transcript",
                exportTitleDefGen:"ENST",
                visible: false,
                type:"string"
            }),
            createColumn({
                id: "export-filter-Transcript",
                data: "annotations.HGVSc",
                searchBuilderTitle:"Transcript",
                exportTitleDefGen:"NM",
                visible: false,
                type:"string",
                renderConfig: {
                    default: (data) => {
                        hgvs_split = String(data).split(":");
                        if (hgvs_split.length > 1) {
                            return hgvs_split[0];
                        }
                        return ""
                    },
                }
            }),
            createColumn({
                id: "export-filter-COSMIC",
                data: "annotations.Existing_variation",
                searchBuilderTitle:"COSMIC",
                exportTitleDefGen:"COSMIC",
                visible: false,
                type:"string",
                renderConfig: {
                    default: (data) => {
                        const vars = []
                        if (data.length > 0) {
                            for (id_var of data) {
                                if (RegExp("^COS[MV][0-9]+").test(id_var)) {
                                    vars.push(id_var);
                                }
                            }
                        }
                        return vars.toString();
                    },
                }
            }),
            createColumn({
                id: "export-filter-RS",
                data: "annotations.Existing_variation",
                searchBuilderTitle:"RS",
                exportTitleDefGen:"RS",
                visible: false,
                type:"string",
                renderConfig: {
                    default: (data) => {
                        const vars = []
                        if (data.length > 0) {
                            for (id_var of data) {
                                if (RegExp("^rs[0-9]+").test(id_var)) {
                                    vars.push(id_var);
                                }
                            }
                        }
                        return vars.toString();
                    },
                }
            }),
            createColumn({
                id: "export-filter-EI",
                data: "annotations",
                searchBuilderTitle:"Exon/Intron",
                exportTitleDefGen:"LOCALISATION",
                visible: false,
                renderConfig: {
                    default: (data) => {
                        if (data.EXON != null) return `Exon ${data.EXON.split("/")[0]}`;
                        if (data.INTRON != null) return `Intron ${data.INTRON.split("/")[0]}`;
                        return "NA";
                    },
                }
            }),
            createColumn({
                id: "export-filter-GnomAD",
                data: "annotations.gnomADg_AF",
                searchBuilderTitle:"GnomADg_AF",
                visible: false,
                renderConfig: {
                    default: (data) => {
                        const gnomad = parseFloat(data);
                        if (isNaN(gnomad) || gnomad == 0) return null;
                        return gnomad;
                    },
                }
            }),
            createColumn({
                id: "export-filter-seal",
                data: "inseal.occurrences",
                searchBuilderTitle:"SEAL",
                visible: false
            }),
            createColumn({
                id: "export-filter-clinvar_revstat",
                data: null,
                searchBuilderTitle:"ClinVar",
                visible: false,
                type: "clinvar",
                renderConfig: {
                    default: (data) => {
                        const clinvar = data.clinvar || {};
                        let value = "2 - NA";

                        if (clinvar.CLNSIG) {
                            if (/benign/i.test(clinvar.CLNSIG)) {
                                value = "0 - Benign/Likely Benign"
                            } else if (/uncertain/i.test(clinvar.CLNSIG)) {
                                value = "3 - Uncertain significance"
                            } else if (/conflicting/i.test(clinvar.CLNSIG)) {
                                value = "1 - Conflicting (without Pathogenic)"
                                if (/pathogenic|establish/i.test(clinvar.CLNSIGCONF)) {
                                    value = "4 - Conflicting (with Pathogenic)"
                                }
                            } else if (/pathogenic|establish/i.test(clinvar.CLNSIG)) {
                                value = "5 - Pathogenic/Likely Pathogenic"
                            } 
                        }
                        return value;
                    },
                }
            }),
            createColumn({
                id: "export-filter-clinvar_revstat",
                data: "clinvar.CLNREVSTAT",
                searchBuilderTitle:"ClinVar Review Stat",
                visible: false,
                type: "CLNREVSTAT"
            }),
            createColumn({
                id: "export-filter-OMIM-inheritances",
                data: "phenotypes",
                searchBuilderTitle:"OMIM inheritances",
                visible: false,
                type: "inheritances",
                renderConfig: {
                    default: (data) => {
                        inheritances_array = []
                        for (d in data) {
                            inh = data[d]["inheritances"].replace(/\[|\]|"|'|\s*/g,'').split(',')
                            inheritances_array = [...new Set([...inheritances_array, ...inh])];
                        }
                        return inheritances_array;
                    },
                }
            }),
            createColumn({
                id: "export-filter-impact",
                data: "annotations.IMPACT",
                searchBuilderTitle:"Impact",
                visible: false,
                type: "impact"
            }),
            createColumn({
                id: "export-filter-consequences",
                data: "annotations.Consequence",
                searchBuilderTitle:"Consequences",
                exportTitleDefGen:"CONSEQUENCES",
                visible: false,
                type: "consequences"
            }),
            createColumn({
                id: "export-filter-MES",
                data: null,
                searchBuilderTitle:"Prediction - MaxEntScan",
                visible: false,
                renderConfig: {
                    default: (data, type) => {
                        const alt = parseFloat(data.annotations.MaxEntScan_alt || 0).toFixed(2);
                        const ref = parseFloat(data.annotations.MaxEntScan_ref || 0).toFixed(2);
                        const mes_var = (((alt - ref) / Math.abs(ref)) * 100).toFixed(2);
                        d = isNaN(parseFloat(mes_var)) ? null: parseFloat(mes_var).toFixed(2);
                        return type === 'export' && d=== null?  '' : Math.abs(d);
                    },
                }
            }),
            createColumn({
                id: "export-filter-spliceAI",
                data: "annotations.spliceAI",
                searchBuilderTitle:"Prediction - SpliceAI",
                visible: false,
                renderConfig: {
                    default: (data, type) => {
                        d = isNaN(parseFloat(data)) ? null: parseFloat(data).toFixed(2);
                        return type === 'export' && d=== null?  '' : d;
                    },
                }
            }),
            createColumn({
                id: "export-filter-missenses",
                data: "annotations.missensesMean",
                searchBuilderTitle:"Prediction - Missenses",
                visible: false,
                renderConfig: {
                    default: (data, type) => {
                        d = isNaN(parseFloat(data)) ? null: parseFloat(data).toFixed(2);
                        return type === 'export' && d=== null?  '' : d;
                    },
                }
            }),
            createColumn({
                id: "export-filter-reported",
                data: "reported",
                searchBuilderTitle:"Reported",
                visible: false,
                type:"reported"
            }),
            createColumn({
                id: "filter-AF",
                data: "allelic_frequency",
                searchBuilderTitle:"Sample AF",
                exportTitle:"{{ sample.samplename }} - AF",
                exportTitleDefGen:"FREQUENCE_ALLELIQUE",
                visible: false
            }),
            createColumn({
                id: "filter-DP",
                data: "depth",
                searchBuilderTitle:"Sample DP",
                exportTitle:"{{ sample.samplename }} - DP",
                visible: false
            }),
            createColumn({
                id: "filter-AD",
                data: "allelic_depth",
                searchBuilderTitle:"Sample AD",
                exportTitle:"{{ sample.samplename }} - AD",
                visible: false
            }),
            createColumn({
                id: "filter-filter_var",
                data: "filter",
                searchBuilderTitle:"Sample filter",
                exportTitle:"{{ sample.samplename }} - filter",
                visible: false
            }),
            {% for c in sample.caller %}
            createColumn({
                id: "export-variant_caller_{{ loop.index }}",
                data: null,
                exportTitle:"{{ sample.samplename }} - {{ c }}",
                visible: false,
                renderConfig: {
                    default: (data) => {
                        if (!("{{ c }}" in data.caller)) return "NA";
                        const caller=data.caller["{{ c }}"];
                        return `[${caller.filter}] ${caller.allelic_frequency} (${caller.allelic_depth}/${caller.depth})`;
                    },
                }
            }),
            {% endfor %}
            // {% if sample.caller|length > 1 %}
            createColumn({
                id: "export-sample",
                data: null,
                exportTitle:"{{ sample.samplename }} - synthesis",
                visible: false,
                renderConfig: {
                    default: (data) => {
                        return `[${data.filter}] ${data.allelic_frequency} (${data.allelic_depth}/${data.depth})`;
                    },
                }
            }),
            // {% endif %}
            // Family Member Columns 
            {% for s in family_members %}
            createColumn({
                id: "export-sample",
                data: "family",
                exportTitle:"FAM - {{ s }} - synthesis",
                visible: false,
                renderConfig: {
                    default: (data) => {
                        const family = data["{{s}}"]
                        if (isNaN(parseFloat(family.allelic_depth)) && isNaN(parseFloat(family.allelic_frequency))) {
                            return "NA"
                        }
                        const af = (isNaN(parseFloat(family.allelic_frequency))) ? ((parseFloat(family.allelic_depth)/parseFloat(family.allelic_frequency))*100).toFixed(2) : '';
                        return `[${family.filter}] ${af} (${family.allelic_depth}/${family.depth})`;
                    },
                }
            }),
            {% endfor %}
        ];

        var number_family = {{ family_members|length }};
        var number_caller = {{ sample.caller|length }};
    </script>

    <script type="text/javascript" src="{{ url_for('static', filename='seal/analysis/sample.js') }}"></script>
{% endblock %}
